export type MetricCategory = 
  | 'sales_revenue'
  | 'forecasting'
  | 'leaderboard'
  | 'client_engine'
  | 'onboarding'
  | 'performance'
  | 'operations';

export interface MetricDefinition {
  id: string;
  name: string;
  category: MetricCategory;
  description: string;
  formula: string;
  dataSource: string;
  updateFrequency: string;
  example?: string;
  relatedMetrics?: string[];
}

export const categoryLabels: Record<MetricCategory, string> = {
  sales_revenue: 'Sales & Revenue',
  forecasting: 'Forecasting',
  leaderboard: 'Leaderboard',
  client_engine: 'Client Engine',
  onboarding: 'Onboarding',
  performance: 'Performance',
  operations: 'Operations',
};

export const categoryIcons: Record<MetricCategory, string> = {
  sales_revenue: 'DollarSign',
  forecasting: 'TrendingUp',
  leaderboard: 'Trophy',
  client_engine: 'Rocket',
  onboarding: 'ClipboardCheck',
  performance: 'BarChart3',
  operations: 'Calendar',
};

export const metricsGlossary: MetricDefinition[] = [
  // Sales & Revenue
  {
    id: 'total-revenue',
    name: 'Total Revenue',
    category: 'sales_revenue',
    description: 'Sum of all service and product sales for the selected date range, synced from Phorest daily summaries.',
    formula: 'SUM(service_revenue + product_revenue)',
    dataSource: 'phorest_daily_summary',
    updateFrequency: 'Hourly sync from Phorest',
    example: '$12,450',
    relatedMetrics: ['services', 'products', 'avg-ticket'],
  },
  {
    id: 'services',
    name: 'Services',
    category: 'sales_revenue',
    description: 'Revenue from all service transactions (cuts, color, treatments, etc.) excluding retail products.',
    formula: "SUM(revenue) WHERE item_type = 'service'",
    dataSource: 'phorest_daily_summary',
    updateFrequency: 'Hourly sync from Phorest',
    example: '$10,200',
    relatedMetrics: ['total-revenue', 'products'],
  },
  {
    id: 'products',
    name: 'Products',
    category: 'sales_revenue',
    description: 'Revenue from retail product sales only, excluding service charges.',
    formula: "SUM(revenue) WHERE item_type = 'product'",
    dataSource: 'phorest_daily_summary',
    updateFrequency: 'Hourly sync from Phorest',
    example: '$2,250',
    relatedMetrics: ['total-revenue', 'retail-percentage'],
  },
  {
    id: 'transactions',
    name: 'Transactions',
    category: 'sales_revenue',
    description: 'Total number of completed sales transactions. One client visit typically equals one transaction.',
    formula: 'COUNT(DISTINCT transaction_id)',
    dataSource: 'phorest_sales_transactions',
    updateFrequency: 'Hourly sync from Phorest',
    example: '47',
    relatedMetrics: ['avg-ticket', 'total-revenue'],
  },
  {
    id: 'avg-ticket',
    name: 'Average Ticket',
    category: 'sales_revenue',
    description: 'Average spend per client visit, calculated by dividing total revenue by number of transactions.',
    formula: 'Total Revenue ÷ Transactions',
    dataSource: 'Calculated from phorest_daily_summary',
    updateFrequency: 'Real-time calculation',
    example: '$265',
    relatedMetrics: ['total-revenue', 'transactions'],
  },
  {
    id: 'retail-percentage',
    name: 'Retail %',
    category: 'sales_revenue',
    description: 'Retail product sales as a percentage of total revenue. Indicates product attachment rate.',
    formula: '(Products ÷ Total Revenue) × 100',
    dataSource: 'Calculated from phorest_daily_summary',
    updateFrequency: 'Real-time calculation',
    example: '18%',
    relatedMetrics: ['products', 'total-revenue'],
  },
  {
    id: 'sales-goal-progress',
    name: 'Sales Goal Progress',
    category: 'sales_revenue',
    description: 'Progress toward your configured monthly or weekly sales target, shown as a percentage.',
    formula: '(Current Revenue ÷ Target Revenue) × 100',
    dataSource: 'sales_goals + phorest_daily_summary',
    updateFrequency: 'Real-time calculation',
    example: '72%',
    relatedMetrics: ['total-revenue'],
  },
  {
    id: 'top-performers',
    name: 'Top Performers',
    category: 'sales_revenue',
    description: 'Stylists ranked by total service plus product revenue for the selected period.',
    formula: 'RANK() OVER (ORDER BY SUM(service + product revenue) DESC)',
    dataSource: 'phorest_daily_summary',
    updateFrequency: 'Hourly sync from Phorest',
    relatedMetrics: ['total-revenue'],
  },

  // Forecasting
  {
    id: 'rev-tomorrow',
    name: 'Revenue Tomorrow',
    category: 'forecasting',
    description: 'Projected revenue from all confirmed and booked appointments scheduled for tomorrow.',
    formula: "SUM(total_price) FROM appointments WHERE date = tomorrow AND status NOT IN ('cancelled', 'no_show')",
    dataSource: 'phorest_appointments',
    updateFrequency: 'Every 5 minutes',
    example: '$3,850',
    relatedMetrics: ['7-day-total'],
  },
  {
    id: '7-day-total',
    name: '7-Day Total',
    category: 'forecasting',
    description: 'Sum of projected revenue from all scheduled appointments over the next 7 days.',
    formula: 'SUM(total_price) FROM appointments WHERE date BETWEEN today AND today + 7',
    dataSource: 'phorest_appointments',
    updateFrequency: 'Every 5 minutes',
    example: '$24,500',
    relatedMetrics: ['daily-avg', 'rev-tomorrow'],
  },
  {
    id: 'daily-avg',
    name: 'Daily Average (Forecast)',
    category: 'forecasting',
    description: 'Average projected daily revenue for the upcoming week, calculated from scheduled appointments.',
    formula: '7-Day Total ÷ 7',
    dataSource: 'Calculated from phorest_appointments',
    updateFrequency: 'Real-time calculation',
    example: '$3,500',
    relatedMetrics: ['7-day-total'],
  },
  {
    id: 'appointment-count',
    name: 'Appointment Count',
    category: 'forecasting',
    description: 'Total number of scheduled appointments for the forecast period.',
    formula: 'COUNT(*) FROM appointments WHERE date IN forecast_range',
    dataSource: 'phorest_appointments',
    updateFrequency: 'Every 5 minutes',
    example: '156',
    relatedMetrics: ['7-day-total'],
  },

  // Leaderboard
  {
    id: 'overall-score',
    name: 'Overall Score',
    category: 'leaderboard',
    description: 'Composite performance score calculated from weighted metrics: new clients, retention, retail, and extensions.',
    formula: '(NewClients × W₁ + Retention × W₂ + Retail × W₃ + Extensions × W₄) normalized to 100',
    dataSource: 'phorest_performance_metrics + leaderboard_weights',
    updateFrequency: 'Weekly snapshot',
    example: '87.5',
    relatedMetrics: ['new-clients', 'retention-rate', 'retail-sales', 'extension-clients'],
  },
  {
    id: 'new-clients',
    name: 'New Clients',
    category: 'leaderboard',
    description: 'Count of first-time clients seen by the stylist during the current week or period.',
    formula: "COUNT(clients) WHERE first_visit_date IN current_period AND stylist_id = user",
    dataSource: 'phorest_performance_metrics',
    updateFrequency: 'Weekly',
    example: '8',
    relatedMetrics: ['overall-score'],
  },
  {
    id: 'retention-rate',
    name: 'Retention Rate',
    category: 'leaderboard',
    description: 'Percentage of clients who return for another visit within the retention window (typically 90 days).',
    formula: '(Returning clients ÷ Total clients from prior period) × 100',
    dataSource: 'phorest_performance_metrics',
    updateFrequency: 'Weekly',
    example: '78%',
    relatedMetrics: ['overall-score', 'rebooking-rate'],
  },
  {
    id: 'retail-sales',
    name: 'Retail Sales (Leaderboard)',
    category: 'leaderboard',
    description: 'Total product revenue generated by the stylist for leaderboard ranking purposes.',
    formula: "SUM(product_revenue) WHERE stylist_id = user",
    dataSource: 'phorest_performance_metrics',
    updateFrequency: 'Weekly',
    example: '$1,250',
    relatedMetrics: ['overall-score', 'retail-percentage'],
  },
  {
    id: 'extension-clients',
    name: 'Extension Clients',
    category: 'leaderboard',
    description: 'Number of clients who received extension services during the period.',
    formula: "COUNT(DISTINCT client_id) WHERE service_type = 'extension'",
    dataSource: 'phorest_performance_metrics',
    updateFrequency: 'Weekly',
    example: '5',
    relatedMetrics: ['overall-score'],
  },
  {
    id: 'streak-count',
    name: 'Streak Count',
    category: 'leaderboard',
    description: 'Number of consecutive days with at least one Ring the Bell entry.',
    formula: 'COUNT(consecutive_days) WHERE ring_entry EXISTS',
    dataSource: 'ring_the_bell_entries',
    updateFrequency: 'Real-time',
    example: '12 days',
    relatedMetrics: ['bells-rung'],
  },

  // Client Engine
  {
    id: 'avg-team-progress',
    name: 'Avg Team Progress',
    category: 'client_engine',
    description: 'Average completion percentage across all stylists enrolled in the Client Engine program.',
    formula: 'AVG(current_day ÷ total_days) × 100 across enrolled stylists',
    dataSource: 'stylist_program_enrollment',
    updateFrequency: 'Real-time',
    example: '64%',
    relatedMetrics: ['enrolled', 'completed'],
  },
  {
    id: 'enrolled',
    name: 'Enrolled',
    category: 'client_engine',
    description: 'Total number of team members currently enrolled in the Client Engine program (any status).',
    formula: "COUNT(enrollments) WHERE status IN ('active', 'paused', 'completed')",
    dataSource: 'stylist_program_enrollment',
    updateFrequency: 'Real-time',
    example: '12',
    relatedMetrics: ['active', 'completed', 'paused'],
  },
  {
    id: 'active',
    name: 'Active (Client Engine)',
    category: 'client_engine',
    description: 'Members who have started but not yet completed the Client Engine program.',
    formula: "COUNT(enrollments) WHERE status = 'active'",
    dataSource: 'stylist_program_enrollment',
    updateFrequency: 'Real-time',
    example: '8',
    relatedMetrics: ['enrolled', 'completed'],
  },
  {
    id: 'completed',
    name: 'Completed (Client Engine)',
    category: 'client_engine',
    description: 'Members who have finished all Client Engine milestones and completed the program.',
    formula: "COUNT(enrollments) WHERE status = 'completed'",
    dataSource: 'stylist_program_enrollment',
    updateFrequency: 'Real-time',
    example: '3',
    relatedMetrics: ['enrolled', 'active'],
  },
  {
    id: 'paused',
    name: 'Paused (Client Engine)',
    category: 'client_engine',
    description: 'Members with Client Engine enrollment temporarily on hold.',
    formula: "COUNT(enrollments) WHERE status = 'paused'",
    dataSource: 'stylist_program_enrollment',
    updateFrequency: 'Real-time',
    example: '1',
    relatedMetrics: ['enrolled'],
  },
  {
    id: 'bells-rung',
    name: 'Bells Rung',
    category: 'client_engine',
    description: 'Total number of Ring the Bell celebration entries logged by enrolled team members.',
    formula: 'COUNT(ring_entries) WHERE user_id IN enrolled_users',
    dataSource: 'ring_the_bell_entries',
    updateFrequency: 'Real-time',
    example: '47',
    relatedMetrics: ['streak-count'],
  },
  {
    id: 'top-streak',
    name: 'Top Streak',
    category: 'client_engine',
    description: 'Longest consecutive days streak achieved by any enrolled team member.',
    formula: 'MAX(current_streak) across all enrolled users',
    dataSource: 'stylist_program_enrollment',
    updateFrequency: 'Real-time',
    example: '23 days',
    relatedMetrics: ['streak-count'],
  },

  // Onboarding
  {
    id: 'team-completion',
    name: 'Team Completion',
    category: 'onboarding',
    description: 'Overall percentage of all onboarding items (tasks + handbooks) completed across all active employees.',
    formula: 'SUM(completed_items) ÷ SUM(total_items) × 100',
    dataSource: 'onboarding_tasks + handbook_acknowledgments',
    updateFrequency: 'Real-time',
    example: '78%',
    relatedMetrics: ['tasks-completed', 'handbooks-acknowledged'],
  },
  {
    id: 'onboarding-total',
    name: 'Total (Onboarding)',
    category: 'onboarding',
    description: 'Count of all active employees currently in the onboarding process.',
    formula: "COUNT(employees) WHERE onboarding_status != 'complete'",
    dataSource: 'employee_profiles',
    updateFrequency: 'Real-time',
    example: '6',
    relatedMetrics: ['onboarding-done', 'onboarding-active'],
  },
  {
    id: 'onboarding-done',
    name: 'Done (Onboarding)',
    category: 'onboarding',
    description: 'Employees who have completed 100% of their onboarding items.',
    formula: 'COUNT(employees) WHERE completion_percentage = 100',
    dataSource: 'onboarding_tasks',
    updateFrequency: 'Real-time',
    example: '2',
    relatedMetrics: ['onboarding-total'],
  },
  {
    id: 'onboarding-active',
    name: 'Active (Onboarding)',
    category: 'onboarding',
    description: 'Employees currently working through their onboarding checklist.',
    formula: 'COUNT(employees) WHERE completion_percentage BETWEEN 1 AND 99',
    dataSource: 'onboarding_tasks',
    updateFrequency: 'Real-time',
    example: '3',
    relatedMetrics: ['onboarding-total'],
  },
  {
    id: 'onboarding-pending',
    name: 'Pending (Onboarding)',
    category: 'onboarding',
    description: "Employees who haven't started any onboarding items yet.",
    formula: 'COUNT(employees) WHERE completion_percentage = 0',
    dataSource: 'onboarding_tasks',
    updateFrequency: 'Real-time',
    example: '1',
    relatedMetrics: ['onboarding-total'],
  },
  {
    id: 'tasks-completed',
    name: 'Tasks Completed',
    category: 'onboarding',
    description: 'Percentage of onboarding tasks marked as complete across all employees.',
    formula: "COUNT(tasks WHERE status = 'complete') ÷ COUNT(all_tasks) × 100",
    dataSource: 'onboarding_tasks',
    updateFrequency: 'Real-time',
    example: '82%',
    relatedMetrics: ['team-completion'],
  },
  {
    id: 'handbooks-acknowledged',
    name: 'Handbooks Acknowledged',
    category: 'onboarding',
    description: 'Percentage of onboarding handbooks acknowledged by employees.',
    formula: 'COUNT(acknowledgments) ÷ COUNT(required_handbooks) × 100',
    dataSource: 'handbook_acknowledgments',
    updateFrequency: 'Real-time',
    example: '75%',
    relatedMetrics: ['team-completion'],
  },
  {
    id: 'business-cards-requested',
    name: 'Business Cards Requested',
    category: 'onboarding',
    description: 'Number of business card requests submitted by new hires.',
    formula: 'COUNT(requests) WHERE type = business_card',
    dataSource: 'business_card_requests',
    updateFrequency: 'Real-time',
    example: '4',
  },
  {
    id: 'headshots-requested',
    name: 'Headshots Requested',
    category: 'onboarding',
    description: 'Number of headshot photo requests submitted by new hires.',
    formula: 'COUNT(requests) WHERE type = headshot',
    dataSource: 'headshot_requests',
    updateFrequency: 'Real-time',
    example: '3',
  },

  // Performance
  {
    id: 'rebooking-rate',
    name: 'Rebooking Rate',
    category: 'performance',
    description: 'Percentage of clients who book their next appointment before leaving the salon.',
    formula: '(Clients rebooked at checkout ÷ Total clients seen) × 100',
    dataSource: 'phorest_performance_metrics',
    updateFrequency: 'Weekly',
    example: '65%',
    relatedMetrics: ['retention-rate'],
  },
  {
    id: 'stylist-avg-ticket',
    name: 'Average Ticket (Stylist)',
    category: 'performance',
    description: 'Average revenue per appointment for an individual stylist.',
    formula: 'Total Revenue ÷ Total Appointments for stylist',
    dataSource: 'phorest_sales_transactions',
    updateFrequency: 'Weekly',
    example: '$285',
    relatedMetrics: ['avg-ticket'],
  },
  {
    id: 'revenue-trend',
    name: 'Revenue Trend',
    category: 'performance',
    description: '8-week rolling comparison showing revenue trajectory over time.',
    formula: 'Weekly revenue values for past 8 weeks, with % change',
    dataSource: 'phorest_daily_summary',
    updateFrequency: 'Weekly',
    example: '+12% vs 8 weeks ago',
    relatedMetrics: ['total-revenue'],
  },
  {
    id: 'client-mix',
    name: 'Client Mix (VIP/At-Risk)',
    category: 'performance',
    description: 'Client segmentation based on visit frequency and recency. VIP = frequent visitors, At-Risk = overdue for visit.',
    formula: 'Segmented by: visit_count >= 6 = VIP, days_since_last_visit > 90 = At-Risk',
    dataSource: 'phorest_appointments',
    updateFrequency: 'Weekly',
    example: 'VIP: 45, At-Risk: 12',
    relatedMetrics: ['retention-rate'],
  },

  // Operations
  {
    id: 'rebook-rate-operational',
    name: 'Rebook Rate (Operational)',
    category: 'operations',
    description: 'Percentage of completed appointments where the client booked their next visit at checkout.',
    formula: '(Appointments with rebooking ÷ Completed appointments) × 100',
    dataSource: 'phorest_appointments',
    updateFrequency: 'Real-time',
    example: '72%',
    relatedMetrics: ['retention-rate', 'rebooking-rate'],
  },
  {
    id: 'client-experience-score',
    name: 'Client Experience Score',
    category: 'operations',
    description: 'Composite score measuring client satisfaction through rebooking, tipping, retention, and retail engagement. Lower scores indicate stylists who may need coaching.',
    formula: '(Rebook Rate × 0.35) + (Tip Rate × 0.30) + (Retention Rate × 0.20) + (Retail Rate × 0.15)',
    dataSource: 'phorest_appointments, phorest_performance_metrics, phorest_transaction_items',
    updateFrequency: 'Real-time',
    example: '72 (Strong)',
    relatedMetrics: ['rebook-rate-operational', 'retention-rate'],
  },
];

export function getMetricsByCategory(category: MetricCategory): MetricDefinition[] {
  return metricsGlossary.filter(m => m.category === category);
}

export function searchMetrics(query: string): MetricDefinition[] {
  const lowerQuery = query.toLowerCase();
  return metricsGlossary.filter(
    m => 
      m.name.toLowerCase().includes(lowerQuery) ||
      m.description.toLowerCase().includes(lowerQuery) ||
      m.formula.toLowerCase().includes(lowerQuery)
  );
}
